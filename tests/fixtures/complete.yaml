openapi: "3.1.0"
info:
  title: Complete API
  version: "2.0.0"
  description: |
    모든 기능을 테스트하기 위한 OpenAPI 문서입니다.
    여러 줄 설명을 포함합니다.
servers:
  - url: https://api.example.com/v2
    description: 운영 서버
  - url: https://staging-api.example.com/v2
    description: 스테이징 서버
tags:
  - name: users
    description: 사용자 관리
  - name: products
    description: 상품 관리
  - name: orders
    description: 주문 관리
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API 키 인증
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 토큰 인증
  schemas:
    User:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: integer
          format: int64
          description: 사용자 ID
        email:
          type: string
          format: email
          description: 이메일 주소
        name:
          type: string
          description: 사용자 이름
        createdAt:
          type: string
          format: date-time
          description: 생성 일시
    Product:
      type: object
      required:
        - id
        - name
        - price
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        price:
          type: number
          format: float
        tags:
          type: array
          items:
            type: string
    Order:
      type: object
      required:
        - id
        - userId
        - items
      properties:
        id:
          type: integer
          format: int64
          description: 주문 ID
        userId:
          type: integer
          format: int64
          description: 사용자 ID
        address:
          type: object
          description: 배송 주소
          properties:
            city:
              type: string
              description: 도시
            street:
              type: string
              description: 거리
            zipCode:
              type: string
              description: 우편번호
        items:
          type: array
          description: 주문 항목 목록
          items:
            type: object
            properties:
              productId:
                type: integer
                format: int64
                description: 상품 ID
              quantity:
                type: integer
                description: 수량
              price:
                type: number
                format: float
                description: 단가
    Error:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          description: 오류 코드
        message:
          type: string
          description: 오류 메시지
    ShippingInfo:
      type: object
      required:
        - orderId
        - sender
        - receiver
      properties:
        orderId:
          type: integer
          format: int64
          description: 주문 ID
        sender:
          type: object
          description: 발송인 정보
          properties:
            name:
              type: string
              description: 발송인 이름
            contact:
              type: object
              description: 연락처 정보
              properties:
                phone:
                  type: string
                  description: 전화번호
                email:
                  type: string
                  format: email
                  description: 이메일
            address:
              type: object
              description: 발송지 주소
              properties:
                city:
                  type: string
                  description: 도시
                street:
                  type: string
                  description: 거리
                zipCode:
                  type: string
                  description: 우편번호
                coordinates:
                  type: object
                  description: GPS 좌표
                  properties:
                    lat:
                      type: number
                      format: double
                      description: 위도
                    lng:
                      type: number
                      format: double
                      description: 경도
        receiver:
          type: object
          description: 수신인 정보
          properties:
            name:
              type: string
              description: 수신인 이름
            address:
              type: object
              description: 배송지 주소
              properties:
                city:
                  type: string
                  description: 도시
                street:
                  type: string
                  description: 거리
                zipCode:
                  type: string
                  description: 우편번호
                detail:
                  type: object
                  description: 상세 주소
                  properties:
                    building:
                      type: string
                      description: 건물명
                    floor:
                      type: integer
                      description: 층
                    room:
                      type: string
                      description: 호수
        tracking:
          type: object
          description: 배송 추적 정보
          properties:
            carrier:
              type: string
              description: 배송 업체
            trackingNumber:
              type: string
              description: 운송장 번호
            history:
              type: array
              description: 배송 이력
              items:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
                    description: 시간
                  status:
                    type: string
                    description: 상태
                  location:
                    type: object
                    description: 위치
                    properties:
                      name:
                        type: string
                        description: 장소명
                      coordinates:
                        type: object
                        description: GPS 좌표
                        properties:
                          lat:
                            type: number
                            format: double
                            description: 위도
                          lng:
                            type: number
                            format: double
                            description: 경도
    UserWithProfile:
      allOf:
        - $ref: "#/components/schemas/User"
        - type: object
          properties:
            profile:
              type: object
              properties:
                bio:
                  type: string
                  description: 자기소개
                avatarUrl:
                  type: string
                  format: uri
                  description: 프로필 이미지 URL
    ProductSearchResult:
      allOf:
        - type: object
          required:
            - totalCount
          properties:
            totalCount:
              type: integer
              description: 전체 검색 결과 수
            page:
              type: integer
              description: 현재 페이지
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/Product"
    PaymentMethod:
      oneOf:
        - type: object
          properties:
            type:
              type: string
              enum: [card]
            cardNumber:
              type: string
              description: 카드 번호
            expiryDate:
              type: string
              description: 만료일
        - type: object
          properties:
            type:
              type: string
              enum: [bank]
            bankName:
              type: string
              description: 은행명
            accountNumber:
              type: string
              description: 계좌번호
    OrderWithPayment:
      allOf:
        - $ref: "#/components/schemas/Order"
        - type: object
          required:
            - payment
          properties:
            payment:
              $ref: "#/components/schemas/PaymentMethod"
            coupon:
              anyOf:
                - type: object
                  properties:
                    code:
                      type: string
                      description: 쿠폰 코드
                    discount:
                      type: number
                      description: 할인 금액
                - type: object
                  properties:
                    code:
                      type: string
                      description: 쿠폰 코드
                    discountRate:
                      type: number
                      description: 할인율 (%)
paths:
  /users:
    get:
      tags:
        - users
      summary: 사용자 목록 조회
      description: 전체 사용자 목록을 조회합니다.
      operationId: getUsers
      security:
        - ApiKeyAuth: []
      parameters:
        - name: page
          in: query
          required: false
          description: 페이지 번호
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          required: false
          description: 페이지당 항목 수
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - users
      summary: 사용자 생성
      description: 새 사용자를 생성합니다.
      operationId: createUser
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
      responses:
        "201":
          description: 생성됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /users/{id}:
    get:
      tags:
        - users
      summary: 사용자 조회
      description: 특정 사용자의 정보를 조회합니다.
      operationId: getUserById
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 사용자 ID
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - users
      summary: 사용자 수정
      description: 사용자 정보를 수정합니다.
      operationId: updateUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
      responses:
        "200":
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
    patch:
      tags:
        - users
      summary: 사용자 부분 수정
      description: 사용자 정보를 부분적으로 수정합니다.
      operationId: patchUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: X-Request-ID
          in: header
          required: false
          description: 요청 추적 ID
          schema:
            type: string
          example: "req-abc-123"
        - name: session_id
          in: cookie
          required: false
          description: 세션 ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: 사용자 이름
            examples:
              changeName:
                summary: 이름 변경
                value:
                  name: "홍길동"
              clearName:
                summary: 이름 초기화
                value:
                  name: ""
      responses:
        "200":
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - users
      summary: 사용자 삭제
      description: 사용자를 삭제합니다.
      operationId: deleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "204":
          description: 삭제됨
        "404":
          description: 사용자를 찾을 수 없음
  /products:
    get:
      tags:
        - products
      summary: 상품 목록 조회
      operationId: getProducts
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: minPrice
          in: query
          schema:
            type: number
        - name: maxPrice
          in: query
          schema:
            type: number
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Product"
  /products/{id}:
    get:
      tags:
        - products
      summary: 상품 조회
      operationId: getProductById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          description: 상품을 찾을 수 없음
  /users/{id}/avatar:
    post:
      tags:
        - users
      summary: 프로필 이미지 업로드
      description: 사용자 프로필 이미지를 업로드합니다.
      operationId: uploadAvatar
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 이미지 파일
                description:
                  type: string
                  description: 이미지 설명
      responses:
        "200":
          description: 업로드 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    description: 업로드된 이미지 URL
        "400":
          description: 잘못된 파일 형식
  /orders:
    post:
      tags:
        - orders
      summary: 주문 생성
      description: 새 주문을 생성합니다.
      operationId: createOrder
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Order"
      responses:
        "201":
          description: 주문 생성됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
              examples:
                simpleOrder:
                  summary: 단순 주문
                  value:
                    id: 1
                    userId: 100
                    address:
                      city: "서울"
                      street: "강남대로 1"
                      zipCode: "06000"
                    items:
                      - productId: 1
                        quantity: 2
                        price: 15000
        "400":
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /users/{id}/profile:
    get:
      tags:
        - users
      summary: 사용자 프로필 조회
      description: 사용자 기본 정보와 프로필을 함께 조회합니다 (allOf).
      operationId: getUserProfile
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserWithProfile"
        "404":
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /products/search:
    get:
      tags:
        - products
      summary: 상품 검색
      description: 상품을 검색합니다 (allOf로 페이지네이션 + 목록 병합).
      operationId: searchProducts
      parameters:
        - name: q
          in: query
          required: true
          description: 검색어
          schema:
            type: string
        - name: page
          in: query
          description: 페이지 번호
          schema:
            type: integer
            default: 1
      responses:
        "200":
          description: 검색 결과
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductSearchResult"
  /orders/with-payment:
    post:
      tags:
        - orders
      summary: 결제 정보 포함 주문 생성
      description: 주문과 결제 정보를 함께 생성합니다 (allOf + oneOf + anyOf 조합).
      operationId: createOrderWithPayment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderWithPayment"
      responses:
        "201":
          description: 주문 생성됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderWithPayment"
        "400":
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /orders/{id}/payment:
    put:
      tags:
        - orders
      summary: 결제 수단 변경
      description: 주문의 결제 수단을 변경합니다 (oneOf).
      operationId: updatePaymentMethod
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PaymentMethod"
      responses:
        "200":
          description: 결제 수단 변경됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentMethod"
        "404":
          description: 주문을 찾을 수 없음
  /orders/{id}/shipping:
    get:
      tags:
        - orders
      summary: 배송 정보 조회
      description: 주문의 배송 정보를 조회합니다 (3단계 이상 깊이의 중첩 객체).
      operationId: getShippingInfo
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 주문 ID
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShippingInfo"
        "404":
          description: 주문을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - orders
      summary: 배송 정보 등록
      description: 주문에 배송 정보를 등록합니다 (3단계 이상 깊이의 중첩 요청 본문).
      operationId: createShippingInfo
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 주문 ID
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShippingInfo"
      responses:
        "201":
          description: 배송 정보 등록됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShippingInfo"
        "400":
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
